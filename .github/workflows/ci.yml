name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json found - skipping npm install"
        fi
        
    - name: Validate HTML
      run: |
        echo "Validating HTML files..."
        find . -name "*.html" -type f | while read file; do
          echo "Validating $file"
          if ! xmllint --noout --html "$file" 2>/dev/null; then
            echo "HTML validation failed for $file"
            exit 1
          fi
        done
      continue-on-error: true
      
    - name: Check CSS syntax
      run: |
        echo "Checking CSS syntax..."
        find . -name "*.css" -type f | while read file; do
          echo "Checking $file"
          if ! npx stylelint "$file" --syntax css 2>/dev/null; then
            echo "CSS check completed with warnings for $file"
          fi
        done
      continue-on-error: true
      
    - name: Build project
      run: |
        echo "Building project..."
        mkdir -p dist
        cp -r *.html *.css dist/ 2>/dev/null || true
        echo "Build completed successfully"
        
    - name: Run tests
      run: |
        echo "Running tests..."
        if [ -f package.json ] && grep -q '"test"' package.json; then
          npm test
        else
          echo "No tests found - creating basic validation test"
          echo "Testing that HTML files exist and are not empty"
          if [ -f dist/index.html ] && [ -s dist/index.html ]; then
            echo "‚úì index.html exists and is not empty"
          else
            echo "‚úó index.html test failed"
            exit 1
          fi
          
          if [ -f dist/styles.css ] && [ -s dist/styles.css ]; then
            echo "‚úì styles.css exists and is not empty"
          else
            echo "‚úó styles.css test failed"
            exit 1
          fi
        fi
        
    - name: Generate build logs
      run: |
        echo "Generating build logs..."
        echo "=== Build Summary ===" > build.log
        echo "Build Date: $(date)" >> build.log
        echo "Commit: ${{ github.sha }}" >> build.log
        echo "Branch: ${{ github.ref_name }}" >> build.log
        echo "" >> build.log
        echo "=== Files Created ===" >> build.log
        find dist -type f -exec ls -la {} \; >> build.log
        echo "" >> build.log
        echo "=== File Sizes ===" >> build.log
        du -sh dist/* >> build.log
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          dist/
          build.log
        retention-days: 30
        
    - name: Upload logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build.log
        retention-days: 7
        
    - name: Deployment readiness check
      run: |
        echo "Checking deployment readiness..."
        if [ -d dist ] && [ "$(find dist -name '*.html' | wc -l)" -gt 0 ]; then
          echo "‚úì Project is ready for deployment"
          echo "üì¶ Build artifacts created successfully"
        else
          echo "‚úó Project not ready for deployment"
          exit 1
        fi

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security scan
      run: |
        echo "Running basic security checks..."
        echo "Checking for sensitive files..."
        if find . -name "*.key" -o -name "*.pem" -o -name ".env*" | grep -q .; then
          echo "‚ö†Ô∏è  Potential sensitive files found"
          find . -name "*.key" -o -name "*.pem" -o -name ".env*"
        else
          echo "‚úì No sensitive files detected"
        fi
        
    - name: Check dependencies
      run: |
        if [ -f package.json ]; then
          echo "Checking for vulnerable dependencies..."
          npm audit --audit-level moderate || true
        else
          echo "No package.json found - skipping dependency check"
        fi
